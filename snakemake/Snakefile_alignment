import os

# To run locally:
# snakemake --snakefile Snakefile_alignment --keep-going --cores 4 --config folder=.. --use-singularity --singularity-prefix ~/.singularity --singularity-args "--home ~"

# To run on bioevo:
# snakemake --snakefile Snakefile_alignment --config folder='/pasteur/homes/azhukova/projects/zika_atlas' --keep-going --cores 1 --use-singularity --singularity-prefix ~/.singularity --singularity-args "--home ~" --cluster "sbatch -c {threads} -o logs/{params.name}.log -e logs/{params.name}.log --mem {params.mem} -p bioevo --qos=bioevo -A bioevo -J {params.name}" --jobs 300

# To visualise the pipeline
# snakemake --snakefile Snakefile_alignment --config folder=.. --dag | dot -Tsvg > pipeline_alignment.svg

localrules: all


folder = os.path.abspath(config["folder"])
data_dir = os.path.join(folder, 'data20200811')


rule all:
    input:
        os.path.join(data_dir, 'aln.fa')

rule get_seq_ids:
    '''
    Extract sequence ids of interest.
    '''
    input:
        tab = os.path.join(data_dir, 'metadata.combined.tab'),
    output:
        tab = os.path.join(data_dir, 'ids.txt')
    params:
        mem = 500,
        name = 'ids',
        qos = 'fast'
    threads: 1
    singularity: "docker://evolbioinfo/python-evol:v3.6"
    shell:
        """
        python3 {folder}/py/get_seq_ids.py --input_data {input.tab} --output_data {output.tab}
        """

rule aln_against_reference:
    '''
    Align sequences against a reference.
    '''
    input:
        fa = os.path.join(data_dir, 'sequences.combined.fa'),
        ref = os.path.join(data_dir, 'ref', 'ZIKV.fa')
    output:
        aln = temp(os.path.join(data_dir, 'aln.ref.fa'))
    params:
        mem = 1000,
        name = 'aln',
        qos = 'fast'
    threads: 12
    singularity: "docker://evolbioinfo/mafft:v7.313"
    shell:
        """
        mafft --thread {threads} --memsave --retree 1 --maxiterate 0 --add {input.fa} \
        --keeplength {input.ref} > {output.aln}
        """

rule remove_ref:
    '''
    Removes the reference from the alignment.
    '''
    input:
        aln = os.path.join(data_dir, 'aln.ref.fa'),
        ids = os.path.join(data_dir, 'ids.txt')
    output:
        aln = os.path.join(data_dir, 'aln.fa')
    params:
        mem = 1000,
        name = 'rmref',
        qos = 'fast',
    threads: 1
    singularity: "docker://evolbioinfo/goalign:v0.3.1"
    shell:
        """
        goalign subset -i {input.aln} -f {input.ids} -o {output.aln}
        """